# 数据库系统

## 数据库基本概念

### 一、事务

#### 事务概念

1. 事务是满足ACID四个特性的一组操作，可以通过commit提交一个事务，也可以用rollback进行回滚

#### 事务的四个特性ACID

1. 原子性：Atomicity。事务是不可分割的最小单元，要么全部提交成功，要么全部失败。

2. 一致性：Consistency。数据库在事务执行前后都是一致性状态。所有事务对同一个数据的读取结果是一样的。

3. 隔离性：Isolation。一个事务对其他事务不可见，做什么是自己的事。

4. 持久性：Durability。一旦提交事务，其做的改变将会永远保存，即便是系统崩溃也不会丢失。可以用redo log重做日志记录，实现持久性。

5. **事务的 ACID 特性概念简单，但不是很好理解，主要是因为这几个特性不是一种平级关系：**

   - 只有满足一致性，事务的执行结果才是正确的。
   - 在无并发的情况下，事务串行执行，隔离性一定能够满足。此时只要能满足原子性，就一定能满足一致性。
   - 在并发的情况下，多个事务并行执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。
   - 事务满足持久化是为了能应对系统崩溃的情况。

   <img src="数据库系统.assets/image-20191207210437023.png" alt="img" style="zoom:50%;" />

6. MySQL默认用自动提交模式，默认把一个操作作为事务进行提交。

### 二、并发一致性问题

并发之下隔离性难以保证，所以一致性难以保证

1. 丢失修改：即两个事务都进行修改，一个修改了但还没有来得及提交就被另一个覆盖了，先后顺序有问题。
2. 读脏数据，一个改了还未提交，另一个读取了，但是改的被撤销了，就导致其读到了脏数据。
3. 不可重复读：一个已经读过了数据，另一个改了，之后再读数据就被更改了
4. 幻影读：读一个范围的数据，另一个事务插入了数据，则数据范围已经被改变了。

这些都是因为改变了事务的隔离性，所以需要加锁进行隔离。

### 三、加锁

#### 封锁粒度

1. 最好只是对相关数据进行加锁，而不是整个表加锁。加锁需要消耗资源，封锁粒度越大则开销越大，要做好权衡。

#### 封锁类型

1. 读写锁：互斥锁以及共享锁，

2. 意向锁Intertion locks：在对一个表进行封锁的时候因为有一行被封锁就不能加锁，这样再去检测某一行是否加锁比较麻烦，所以有了意向锁，IX和IS，预先加上，都是对表的锁定，表示自己想要对某个数据行加上X和S锁。一个事务想要获得S与X都必须现有IS与IX。

   <img src="数据库系统.assets/image-20191207214442687.png" alt="img" style="zoom:50%;" />

3. 任意的IS与IX之间都是兼容的，因为只是意向加锁而不是真正加锁。意向锁都是表级的，所以对分别两行加锁是不冲突的。

#### 封锁类型

1. 三级封锁协议：修改A的时候要加X锁，事务结束才释放。二级是读要加S锁，读完就释放。三级是读加S锁，事务结束才释放。
2. 两段锁协议，加锁和解锁在两个阶段进行。两段锁可以保证可串行化调度，但是不满足也可能达到。
3. MySQL的InnoDB存储引擎采用了两段锁协议，根据隔离级别自动加锁，后面再一起释放，这是隐式锁定。

### 四、隔离级别

1. 未提交读：事务修改之后未提交但还是可以被其他事务可见
2. 提交读：只有提交之后才可以被看到
3. 可重复读：保证同一个事务之中多次读取数据的结果是一样的
4. 可串行化：强制事务串行执行，这样两个事务互不干扰，这个需要加锁实现

### 五、多版本并发控制

1. MVCC Multi-Version Concurrency Control。是MySQL的InnoDB存储引擎实现隔离的具体方式。实现了提交读和可重复读的隔离级别。读操作实际较多，加锁比较浪费，MVCC用多版本的思想，写操作更新最新的版本快照，读操作读旧版本，没有互斥关系。其规定了只能读取别的已经提交的事务，还有自己未提交的脏页面。
2. MVCC的多个版本快照存储在Undo日志里面，里面有版本号
3. MVCC维护了一个ReadView的结构，存储了当前系统未提交的事务列表，还有其中版本号的最大最小值。在select的时候，根据当前的和min，max的比较得出一定结论。如果小于最小，那么表示当前的行是在所有未提交之前的，可以使用。如大于max，说明是在未提交后面，不可使用。如果在中间，需要根据隔离等级决定能否使用。如果当前的不可用就需要找到下一个快照版本使用。

## MySQL相关概念

### 一、索引

1. 






















